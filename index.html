<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamy Audio Editor - Pastel Edition</title>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
    <style>
:root {
    --bg-dreamy: #2a2a35;
    --panel-dreamy: #343442;
    --pastel-pink: #ffadcc;
    --pastel-rose: #ff85a2;
    --pastel-orange: #ffcc99;
    --pastel-peach: #ffa07a;
    --text-light: #f0f0f0;
}

body { 
    background-color: var(--bg-dreamy); color: var(--text-light); 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 20px; display: flex; justify-content: center; 
}

.container { 
    width: 100%; max-width: 1200px; 
    background: var(--panel-dreamy); 
    padding: 25px; border-radius: 16px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    border: 1px solid rgba(255, 173, 204, 0.1);
}

h2 {
    background: linear-gradient(to right, var(--pastel-pink), var(--pastel-orange));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
}

#waveform {
    border-radius: 8px; 
    background: rgba(255,255,255,0.05); 
    margin: 20px 0; 
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative; z-index: 1;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
}

.control-row { display: flex; gap: 15px; align-items: center; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }

.time-group {
    background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 12px;
    display: flex; flex-direction: column; align-items: center;
}
.time-label { font-size: 0.8em; font-weight: bold; margin-bottom: 5px; letter-spacing: 1px;}

.time-box {
    background: transparent; border: 2px solid rgba(255,255,255,0.2); color: var(--text-light); padding: 8px; 
    font-family: monospace; font-size: 1.4em; width: 130px; text-align: center; border-radius: 8px; font-weight: bold;
    transition: all 0.3s;
}
.time-box:focus { outline: none; border-color: var(--pastel-pink); box-shadow: 0 0 15px rgba(255, 173, 204, 0.3); }

.btn-main { 
    padding: 12px 24px; 
    background: linear-gradient(135deg, #444, #555); 
    color: white; border: none; cursor: pointer; border-radius: 30px; font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); background: linear-gradient(135deg, #555, #666); }
.btn-main:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-play { width: 55px; height: 55px; border-radius: 50%; background: linear-gradient(135deg, var(--pastel-pink), var(--pastel-orange)); color: #fff; font-size: 22px; border: none; cursor: pointer; box-shadow: 0 0 20px rgba(255, 173, 204, 0.5); transition: transform 0.2s; }
.btn-play:hover { transform: scale(1.1); }

.btn-export {
    background: linear-gradient(to right, var(--pastel-rose), var(--pastel-peach)) !important;
    color: white !important; font-size: 1.1em;
}
.btn-export:hover {
     box-shadow: 0 0 25px rgba(255, 133, 162, 0.6) !important;
}

select { background: #444; color: white; border: 1px solid #555; padding: 10px; border-radius: 8px; cursor: pointer; }
input[type=range] { accent-color: var(--pastel-pink); cursor: pointer; }
.slider-group { display: flex; flex-direction: column; align-items: flex-start; gap: 8px; background: rgba(0,0,0,0.2); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
.slider-label { font-size: 0.9em; color: #ccc; }
.highlight-val { color: var(--pastel-pink); font-weight: bold; }

#loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(42, 42, 53, 0.95); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 173, 204, 0.2); border-top-color: var(--pastel-pink); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }

.file-size-info {
    background: rgba(0,0,0,0.3); padding: 15px 20px; border-radius: 12px; 
    border: 1px solid rgba(255,255,255,0.1); margin: 15px 0;
    display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: center;
}
.size-item { text-align: center; }
.size-label { font-size: 0.8em; color: #aaa; margin-bottom: 5px; }
.size-value { font-size: 1.3em; font-weight: bold; color: var(--pastel-pink); }

.tab-buttons {
    display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;
}
.tab-btn {
    padding: 12px 30px; background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2);
    color: white; border-radius: 30px; cursor: pointer; font-weight: 600; transition: all 0.3s;
}
.tab-btn.active {
    background: linear-gradient(135deg, var(--pastel-pink), var(--pastel-orange));
    border-color: transparent;
}
.tab-btn:hover { transform: translateY(-2px); }

.tab-content { display: none; }
.tab-content.active { display: block; }

.multi-file-list {
    background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; margin: 15px 0;
    max-height: 400px; overflow-y: auto;
}
.file-item {
    background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;
    border: 1px solid rgba(255,255,255,0.1); position: relative;
}
.file-item-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
}
.file-name { font-weight: bold; color: var(--pastel-pink); }
.file-duration { color: #aaa; font-size: 0.9em; }
.file-controls {
    display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;
}
.btn-small {
    padding: 6px 12px; font-size: 0.85em; border-radius: 20px;
    background: #555; color: white; border: none; cursor: pointer;
}
.btn-small:hover { background: #666; }
.btn-small:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-danger { background: #d64545 !important; }
.btn-danger:hover { background: #e05555 !important; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; color: var(--pastel-pink); font-weight: 500;" id="loadingText">ƒêang t·∫£i tr·∫£i nghi·ªám...</div>
</div>

<div class="container">
    <div class="control-row" style="justify-content: space-between;">
        <h2 style="margin:0;">‚ú® DREAMY STUDIO <small style="font-size:0.6em; opacity: 0.7;">Pastel Tone</small></h2>
    </div>

    <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('cut')">‚úÇÔ∏è C·∫Øt File</button>
        <button class="tab-btn" onclick="switchTab('merge')">üîó Gh√©p File</button>
    </div>

    <!-- TAB C·∫ÆT FILE -->
    <div id="cutTab" class="tab-content active">
        <div class="control-row">
            <label class="btn-main" style="background: linear-gradient(135deg, var(--pastel-pink), var(--pastel-orange)); border:none;">
                üìÇ M·ªü File Nh·∫°c/Video
                <input type="file" id="fileInput" accept="audio/*,video/*" style="display:none">
            </label>
        </div>

        <div class="file-size-info" id="singleFileSizeInfo" style="display:none;">
            <div class="size-item">
                <div class="size-label">File g·ªëc</div>
                <div class="size-value" id="originalSize">0 MB</div>
            </div>
            <div class="size-item">
                <div class="size-label">128 kbps</div>
                <div class="size-value" id="estimate128">0 MB</div>
            </div>
            <div class="size-item">
                <div class="size-label">192 kbps</div>
                <div class="size-value" id="estimate192">0 MB</div>
            </div>
            <div class="size-item">
                <div class="size-label">256 kbps</div>
                <div class="size-value" id="estimate256">0 MB</div>
            </div>
            <div class="size-item">
                <div class="size-label">320 kbps</div>
                <div class="size-value" id="estimate320">0 MB</div>
            </div>
        </div>

        <div class="control-row" style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 16px;">
            <div class="time-group">
                <div class="time-label" style="color: var(--pastel-pink);">START</div>
                <input type="number" id="startTime" class="time-box" style="color: var(--pastel-pink); border-color: var(--pastel-pink);" step="0.001">
            </div>
            
            <div style="text-align: center; margin: 0 30px; min-width: 180px;">
                <div style="color: #e9b5b5; font-size: 0.8em; margin-bottom: 5px;">TH·ªúI GIAN ƒêANG PH√ÅT</div>
                <div id="currentTime" style="font-size: 2.2em; font-family: monospace; font-weight:bold; 
                background: linear-gradient(to right, var(--pastel-pink), var(--pastel-orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    00:00.000
                </div>
            </div>

            <div class="time-group">
                <div class="time-label" style="color: var(--pastel-orange);">END</div>
                <input type="number" id="endTime" class="time-box" style="color: var(--pastel-orange); border-color: var(--pastel-orange);" step="0.001">
            </div>
        </div>

        <div id="waveform"></div>

        <div class="control-row">
            <button class="btn-main" onclick="skip(-5)">‚è™ -5s</button>
            <button class="btn-play" onclick="playPause()">‚ñ∂</button>
            <button class="btn-main" onclick="skip(5)">+5s ‚è©</button>
        </div>

        <div class="control-row">
            <div class="slider-group">
                <span class="slider-label">‚ö° T·ªëc ƒë·ªô: <b id="speedDisplay" class="highlight-val">1.0x</b></span>
                <input type="range" id="previewSpeed" min="0.5" max="2.0" step="0.1" value="1.0" style="width: 180px;">
            </div>

            <div class="slider-group">
                <span class="slider-label">üìä √Çm l∆∞·ª£ng: <b id="volDisplay" class="highlight-val" style="color: var(--pastel-orange)">100%</b></span>
                <input type="range" id="previewVolume" min="0" max="300" step="10" value="100" style="width: 180px; accent-color: var(--pastel-orange);">
            </div>
            
            <div class="slider-group">
                <span class="slider-label">üîç Zoom</span>
                <input type="range" id="zoomSlider" min="10" max="500" value="50" style="width: 100px;">
            </div>
        </div>

        <hr style="border-color: rgba(255,255,255,0.1); margin: 25px 0;">

        <div class="control-row">
            <select id="cutMode" class="btn-main">
                <option value="keep">‚úÇÔ∏è L·∫•y v√πng ch·ªçn</option>
                <option value="remove">üóëÔ∏è X√≥a v√πng ch·ªçn</option>
            </select>
            
            <select id="format" class="btn-main">
                <option value="mp3">MP3</option>
                <option value="wav">WAV</option>
            </select>

            <select id="bitrate" class="btn-main">
                <option value="128k">128 kbps</option>
                <option value="192k">192 kbps</option>
                <option value="256k">256 kbps</option>
                <option value="320k" selected>320 kbps</option>
            </select>

            <button class="btn-main btn-export" onclick="exportFile()">
                üíæ EXPORT
            </button>
        </div>
    </div>

    <!-- TAB GH√âP FILE -->
    <div id="mergeTab" class="tab-content">
        <div class="control-row">
            <label class="btn-main" style="background: linear-gradient(135deg, var(--pastel-pink), var(--pastel-orange)); border:none;">
                üìÇ Th√™m File (Nhi·ªÅu file)
                <input type="file" id="multiFileInput" accept="audio/*,video/*" multiple style="display:none">
            </label>
        </div>

        <div class="file-size-info" id="mergeFileSizeInfo" style="display:none;">
            <div class="size-item">
                <div class="size-label">T·ªïng th·ªùi gian</div>
                <div class="size-value" id="totalDuration">0:00</div>
            </div>
            <div class="size-item">
                <div class="size-label">Dung l∆∞·ª£ng d·ª± ki·∫øn</div>
                <div class="size-value" id="mergeEstimate">0 MB</div>
            </div>
        </div>

        <div class="multi-file-list" id="fileList"></div>

        <div class="control-row">
            <div class="slider-group">
                <span class="slider-label">‚ö° T·ªëc ƒë·ªô chung: <b id="mergeSpeedDisplay" class="highlight-val">1.0x</b></span>
                <input type="range" id="mergeSpeed" min="0.5" max="2.0" step="0.1" value="1.0" style="width: 180px;">
            </div>

            <div class="slider-group">
                <span class="slider-label">üìä √Çm l∆∞·ª£ng chung: <b id="mergeVolDisplay" class="highlight-val" style="color: var(--pastel-orange)">100%</b></span>
                <input type="range" id="mergeVolume" min="0" max="300" step="10" value="100" style="width: 180px; accent-color: var(--pastel-orange);">
            </div>
        </div>

        <div class="control-row">
            <select id="mergeFormat" class="btn-main">
                <option value="mp3">MP3</option>
                <option value="wav">WAV</option>
            </select>

            <select id="mergeBitrate" class="btn-main" onchange="updateMergeEstimates()">
                <option value="128k">128 kbps</option>
                <option value="192k">192 kbps</option>
                <option value="256k">256 kbps</option>
                <option value="320k" selected>320 kbps</option>
            </select>

            <button class="btn-main btn-export" onclick="mergeFiles()">
                üîó GH√âP & EXPORT
            </button>
        </div>
    </div>
</div>

<script>
// Service Worker for FFMPEG (COI)
if (typeof window !== 'undefined') {
    const n = window.navigator;
    if (n.serviceWorker && n.serviceWorker.controller) {
        n.serviceWorker.controller.postMessage({ type: "coepCredentialless", value: false });
    } else {
        const swCode = `
self.addEventListener("install", () => self.skipWaiting());
self.addEventListener("activate", (e) => e.waitUntil(self.clients.claim()));
self.addEventListener("fetch", function (event) {
    const r = event.request;
    if (r.cache === "only-if-cached" && r.mode !== "same-origin") return;
    event.respondWith(fetch(r).then((response) => {
        if (response.status === 0) return response;
        const newHeaders = new Headers(response.headers);
        newHeaders.set("Cross-Origin-Embedder-Policy", "require-corp");
        newHeaders.set("Cross-Origin-Opener-Policy", "same-origin");
        return new Response(response.body, { status: response.status, statusText: response.statusText, headers: newHeaders });
    }).catch((e) => console.error(e)));
});`;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        n.serviceWorker.register(swUrl).then((r) => {
            r.addEventListener("updatefound", () => window.location.reload());
            if (r.installing) r.installing.addEventListener("statechange", function () {
                if (this.state === "activated") window.location.reload();
            });
        });
    }
}

let wavesurfer, wsRegions;
let audioContext = new (window.AudioContext || window.webkitAudioContext)();
let audioBuffer = null; 
let originalFileName = "Audio";
let originalFileSize = 0;
let multiFiles = [];

const { createFFmpeg } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

async function init() {
    showLoading(true, "ƒêang kh·ªüi t·∫°o Studio...");
    if (!ffmpeg.isLoaded()) await ffmpeg.load();

    const ctx = document.createElement('canvas').getContext('2d');
    const waveGradient = ctx.createLinearGradient(0, 0, 0, 150);
    waveGradient.addColorStop(0, '#ffc3a0');
    waveGradient.addColorStop(1, '#ffafbd');

    const progressGradient = ctx.createLinearGradient(0, 0, 0, 150);
    progressGradient.addColorStop(0, '#ff9a44');
    progressGradient.addColorStop(1, '#fc6767');

    wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: waveGradient,
        progressColor: progressGradient,
        cursorColor: '#fff',
        height: 160,
        barWidth: 3,
        barRadius: 3,
        normalize: true,
        minPxPerSec: 50,
        backend: 'MediaElement'
    });

    wsRegions = wavesurfer.registerPlugin(WaveSurfer.Regions.create());

    wavesurfer.on('timeupdate', (t) => {
        document.getElementById('currentTime').innerText = fmtTime(t);
    });

    wsRegions.on('region-created', (region) => {
        styleRegionDreamy(region);
    });
    
    wsRegions.on('region-updated', (region) => {
        const startInput = document.getElementById('startTime');
        const endInput = document.getElementById('endTime');
        if (document.activeElement !== startInput) startInput.value = region.start.toFixed(3);
        if (document.activeElement !== endInput) endInput.value = region.end.toFixed(3);
    });

    showLoading(false);
}
init();

function styleRegionDreamy(region) {
    setTimeout(() => {
        const regionEl = region.element; 
        if (!regionEl) return;

        regionEl.style.background = 'linear-gradient(to right, rgba(255, 173, 204, 0.2), rgba(255, 204, 153, 0.2))';
        regionEl.style.border = '1px solid rgba(255, 255, 255, 0.2)';
        regionEl.style.backdropFilter = 'blur(2px)';

        const leftHandle = regionEl.querySelector('[data-region-handle="start"]');
        const rightHandle = regionEl.querySelector('[data-region-handle="end"]');

        if (leftHandle) {
            leftHandle.style.background = 'linear-gradient(to bottom, #ffadcc, #ff85a2)';
            leftHandle.style.width = '6px';
            leftHandle.style.boxShadow = '-2px 0 15px rgba(255, 173, 204, 0.8)';
        }
        if (rightHandle) {
            rightHandle.style.background = 'linear-gradient(to bottom, #ffcc99, #ffa07a)';
            rightHandle.style.width = '6px';
            rightHandle.style.boxShadow = '2px 0 15px rgba(255, 204, 153, 0.8)';
        }
    }, 50);
}

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    if (tab === 'cut') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('cutTab').classList.add('active');
    } else {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('mergeTab').classList.add('active');
    }
}

function calculateFileSize(durationSec, bitrate) {
    const bitrateNum = parseInt(bitrate.replace('k', ''));
    const sizeKB = (durationSec * bitrateNum) / 8;
    const sizeMB = sizeKB / 1024;
    return sizeMB.toFixed(2);
}

function updateSizeEstimates(duration, originalSize) {
    document.getElementById('singleFileSizeInfo').style.display = 'flex';
    document.getElementById('originalSize').textContent = (originalSize / (1024 * 1024)).toFixed(2) + ' MB';
    document.getElementById('estimate128').textContent = calculateFileSize(duration, '128k') + ' MB';
    document.getElementById('estimate192').textContent = calculateFileSize(duration, '192k') + ' MB';
    document.getElementById('estimate256').textContent = calculateFileSize(duration, '256k') + ' MB';
    document.getElementById('estimate320').textContent = calculateFileSize(duration, '320k') + ' MB';
}

const startInput = document.getElementById('startTime');
const endInput = document.getElementById('endTime');
startInput.addEventListener('input', updateRegionFromInput);
endInput.addEventListener('input', updateRegionFromInput);

function updateRegionFromInput() {
    const s = parseFloat(startInput.value);
    const e = parseFloat(endInput.value);
    if (isNaN(s) || isNaN(e)) return;
    const regions = wsRegions.getRegions();
    if (regions.length > 0) {
        if (s < e) regions[0].setOptions({ start: s, end: e });
    }
}

document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    originalFileName = file.name.replace(/\.[^/.]+$/, ""); 
    originalFileSize = file.size;
    showLoading(true, "ƒêang ph√¢n t√≠ch s√≥ng √¢m...");
    const url = URL.createObjectURL(file);
    await wavesurfer.load(url);
    const ab = await file.arrayBuffer();
    audioBuffer = await audioContext.decodeAudioData(ab);
    wsRegions.clearRegions();
    wsRegions.addRegion({
        start: audioBuffer.duration * 0.1, end: audioBuffer.duration * 0.9, drag: true, resize: true
    });
    updateSizeEstimates(audioBuffer.duration, originalFileSize);
    showLoading(false);
});

document.getElementById('previewSpeed').addEventListener('input', function() {
    const val = parseFloat(this.value);
    document.getElementById('speedDisplay').innerText = val + 'x';
    wavesurfer.setPlaybackRate(val, true); 
});

document.getElementById('previewVolume').addEventListener('input', function() {
    const val = parseInt(this.value);
    document.getElementById('volDisplay').innerText = val + '%';
    wavesurfer.setVolume(val / 100);
});

document.getElementById('mergeSpeed').addEventListener('input', function() {
    document.getElementById('mergeSpeedDisplay').innerText = parseFloat(this.value) + 'x';
});

document.getElementById('mergeVolume').addEventListener('input', function() {
    document.getElementById('mergeVolDisplay').innerText = parseInt(this.value) + '%';
});

// MULTI FILE HANDLING
document.getElementById('multiFileInput').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;
    showLoading(true, "ƒêang x·ª≠ l√Ω files...");
    
    for (let file of files) {
        const ab = await file.arrayBuffer();
        const buffer = await audioContext.decodeAudioData(ab);
        multiFiles.push({
            id: Date.now() + Math.random(),
            name: file.name,
            file: file,
            buffer: buffer,
            duration: buffer.duration,
            trimStart: 0,
            trimEnd: buffer.duration,
            removeRegions: []
        });
    }
    
    renderFileList();
    updateMergeEstimates();
    showLoading(false);
});

function renderFileList() {
    const list = document.getElementById('fileList');
    list.innerHTML = '';
    
    if (multiFiles.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#aaa; padding:20px;">Ch∆∞a c√≥ file n√†o. Nh·∫•n "Th√™m File" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>';
        return;
    }
    
    multiFiles.forEach((fileData, index) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
            <div class="file-item-header">
                <span class="file-name">${index + 1}. ${fileData.name}</span>
                <span class="file-duration">${fmtTime(fileData.duration)}</span>
            </div>
            <div style="font-size: 0.85em; color: #aaa; margin-bottom: 8px;">
                Trim: ${fileData.trimStart.toFixed(2)}s ‚Üí ${fileData.trimEnd.toFixed(2)}s
                ${fileData.removeRegions.length > 0 ? `| X√≥a ${fileData.removeRegions.length} ƒëo·∫°n` : ''}
            </div>
            <div class="file-controls">
                <button class="btn-small" onclick="editFileTrim(${index})">‚úÇÔ∏è C·∫Øt ƒë·∫ßu/cu·ªëi</button>
                <button class="btn-small" onclick="editFileRemove(${index})">üóëÔ∏è C·∫Øt ƒëo·∫°n gi·ªØa</button>
                <button class="btn-small" onclick="moveFile(${index}, -1)" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                <button class="btn-small" onclick="moveFile(${index}, 1)" ${index === multiFiles.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
                <button class="btn-small btn-danger" onclick="removeFile(${index})">‚ùå X√≥a</button>
            </div>
        `;
        list.appendChild(div);
    });
    
    if (multiFiles.length > 0) {
        document.getElementById('mergeFileSizeInfo').style.display = 'flex';
    }
}

function editFileTrim(index) {
    const file = multiFiles[index];
    const start = prompt(`C·∫Øt ƒë·∫ßu file "${file.name}"\nTh·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu (gi√¢y):`, file.trimStart);
    if (start === null) return;
    const end = prompt(`Th·ªùi ƒëi·ªÉm k·∫øt th√∫c (gi√¢y):`, file.trimEnd);
    if (end === null) return;
    
    const s = parseFloat(start);
    const e = parseFloat(end);
    if (!isNaN(s) && !isNaN(e) && s >= 0 && e <= file.duration && s < e) {
        file.trimStart = s;
        file.trimEnd = e;
        renderFileList();
        updateMergeEstimates();
    } else {
        alert('Gi√° tr·ªã kh√¥ng h·ª£p l·ªá!');
    }
}

function editFileRemove(index) {
    const file = multiFiles[index];
    const start = prompt(`X√≥a ƒëo·∫°n gi·ªØa "${file.name}"\nTh·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu x√≥a (gi√¢y):`, '0');
    if (start === null) return;
    const end = prompt(`Th·ªùi ƒëi·ªÉm k·∫øt th√∫c x√≥a (gi√¢y):`, '1');
    if (end === null) return;
    
    const s = parseFloat(start);
    const e = parseFloat(end);
    if (!isNaN(s) && !isNaN(e) && s >= file.trimStart && e <= file.trimEnd && s < e) {
        file.removeRegions.push({ start: s, end: e });
        renderFileList();
        updateMergeEstimates();
    } else {
        alert('Gi√° tr·ªã kh√¥ng h·ª£p l·ªá!');
    }
}

function moveFile(index, direction) {
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= multiFiles.length) return;
    [multiFiles[index], multiFiles[newIndex]] = [multiFiles[newIndex], multiFiles[index]];
    renderFileList();
}

function removeFile(index) {
    if (confirm('X√≥a file n√†y kh·ªèi danh s√°ch?')) {
        multiFiles.splice(index, 1);
        renderFileList();
        updateMergeEstimates();
    }
}

function updateMergeEstimates() {
    let totalDur = 0;
    multiFiles.forEach(f => {
        let dur = f.trimEnd - f.trimStart;
        f.removeRegions.forEach(r => dur -= (r.end - r.start));
        totalDur += dur;
    });
    
    document.getElementById('totalDuration').textContent = fmtTime(totalDur);
    const bitrate = document.getElementById('mergeBitrate').value;
    document.getElementById('mergeEstimate').textContent = calculateFileSize(totalDur, bitrate) + ' MB';
}

async function mergeFiles() {
    if (multiFiles.length === 0) return alert("Ch∆∞a c√≥ file n√†o!");
    showLoading(true, "ƒêang gh√©p files...");
    
    try {
        const speed = parseFloat(document.getElementById('mergeSpeed').value);
        const volumePercent = parseInt(document.getElementById('mergeVolume').value);
        const volumeFactor = volumePercent / 100;
        const bitrate = document.getElementById('mergeBitrate').value;
        const format = document.getElementById('mergeFormat').value;
        
        const fileList = [];
        
        for (let i = 0; i < multiFiles.length; i++) {
            const fileData = multiFiles[i];
            const buffer = fileData.buffer;
            const rate = buffer.sampleRate;
            
            let segments = [];
            let currentStart = Math.floor(fileData.trimStart * rate);
            
            const sortedRemove = [...fileData.removeRegions].sort((a, b) => a.start - b.start);
            
            for (let region of sortedRemove) {
                const rStart = Math.floor(region.start * rate);
                const rEnd = Math.floor(region.end * rate);
                if (rStart > currentStart) {
                    segments.push({ start: currentStart, end: rStart });
                }
                currentStart = rEnd;
            }
            
            const trimEndSample = Math.floor(fileData.trimEnd * rate);
            if (currentStart < trimEndSample) {
                segments.push({ start: currentStart, end: trimEndSample });
            }
            
            let totalLen = 0;
            segments.forEach(seg => totalLen += (seg.end - seg.start));
            
            let newBuf = audioContext.createBuffer(buffer.numberOfChannels, totalLen, rate);
            let writePos = 0;
            
            for (let ch = 0; ch < buffer.numberOfChannels; ch++) {
                const oldData = buffer.getChannelData(ch);
                const newData = newBuf.getChannelData(ch);
                writePos = 0;
                
                for (let seg of segments) {
                    const segData = oldData.slice(seg.start, seg.end);
                    newData.set(segData, writePos);
                    writePos += segData.length;
                }
            }
            
            const wavData = bufferToWave(newBuf);
            const fname = `temp_${i}.wav`;
            ffmpeg.FS('writeFile', fname, wavData);
            fileList.push(fname);
        }
        
        let concatContent = '';
        fileList.forEach(f => concatContent += `file '${f}'\n`);
        ffmpeg.FS('writeFile', 'concat.txt', new TextEncoder().encode(concatContent));
        
        let filterChain = [];
        if (speed !== 1.0) filterChain.push(`atempo=${speed}`);
        if (volumeFactor !== 1.0) filterChain.push(`volume=${volumeFactor}`);
        
        let args = ['-f', 'concat', '-safe', '0', '-i', 'concat.txt'];
        if (filterChain.length > 0) args.push('-filter:a', filterChain.join(','));
        args.push('-b:a', bitrate);
        args.push(`output_merged.${format}`);
        
        await ffmpeg.run(...args);
        
        const data = ffmpeg.FS('readFile', `output_merged.${format}`);
        const blob = new Blob([data.buffer], { type: `audio/${format}` });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `merged_audio.${format}`;
        a.click();
        
        fileList.forEach(f => ffmpeg.FS('unlink', f));
        ffmpeg.FS('unlink', 'concat.txt');
        ffmpeg.FS('unlink', `output_merged.${format}`);
        
    } catch (err) {
        alert("L·ªói: " + err.message);
        console.error(err);
    }
    showLoading(false);
}

async function exportFile() {
    if (!audioBuffer) return alert("Ch∆∞a c√≥ file!");
    showLoading(true, "ƒêang x·ª≠ l√Ω & Xu·∫•t file...");

    try {
        const r = wsRegions.getRegions()[0];
        const mode = document.getElementById('cutMode').value;
        const speed = parseFloat(document.getElementById('previewSpeed').value);
        const volumePercent = parseInt(document.getElementById('previewVolume').value);
        const volumeFactor = volumePercent / 100;

        const rate = audioBuffer.sampleRate;
        const s = Math.floor(r.start * rate);
        const e = Math.floor(r.end * rate);
        let newLen = (mode === 'keep') ? (e - s) : (audioBuffer.length - (e - s));
        let newBuf = audioContext.createBuffer(audioBuffer.numberOfChannels, newLen, rate);

        for (let i = 0; i < audioBuffer.numberOfChannels; i++) {
            const oldD = audioBuffer.getChannelData(i);
            const newD = newBuf.getChannelData(i);
            if (mode === 'keep') newD.set(oldD.slice(s, e));
            else { newD.set(oldD.slice(0, s)); newD.set(oldD.slice(e), s); }
        }

        const wavData = bufferToWave(newBuf);
        const fname = 'temp.wav';
        const outFmt = document.getElementById('format').value;
        const outName = `output.${outFmt}`;
        
        ffmpeg.FS('writeFile', fname, wavData);

        let filterChain = [];
        if (speed !== 1.0) filterChain.push(`atempo=${speed}`);
        if (volumeFactor !== 1.0) filterChain.push(`volume=${volumeFactor}`);

        let args = ['-i', fname];
        if (filterChain.length > 0) args.push('-filter:a', filterChain.join(','));
        args.push('-b:a', document.getElementById('bitrate').value);
        args.push(outName);

        await ffmpeg.run(...args);

        const data = ffmpeg.FS('readFile', outName);
        const blob = new Blob([data.buffer], { type: `audio/${outFmt}` });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${originalFileName}_edited.${outFmt}`;
        a.click();

        ffmpeg.FS('unlink', fname);
        ffmpeg.FS('unlink', outName);

    } catch (err) {
        alert("L·ªói: " + err.message); 
        console.error(err);
    }
    showLoading(false);
}

function playPause() { wavesurfer.playPause(); }
function skip(s) { wavesurfer.skip(s); }
document.getElementById('zoomSlider').addEventListener('input', function(){ wavesurfer.zoom(Number(this.value)); });

function bufferToWave(abuffer) {
    let numOfChan = abuffer.numberOfChannels, len = abuffer.length * numOfChan * 2 + 44, buffer = new ArrayBuffer(len), view = new DataView(buffer), channels = [], i, sample, offset = 0, pos = 0;
    writeStr(view, 0, 'RIFF'); view.setUint32(4, 36 + abuffer.length * numOfChan * 2, true); writeStr(view, 8, 'WAVE'); writeStr(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numOfChan, true); view.setUint32(24, abuffer.sampleRate, true); view.setUint32(28, abuffer.sampleRate * 2 * numOfChan, true); view.setUint16(32, numOfChan * 2, true); view.setUint16(34, 16, true); writeStr(view, 36, 'data'); view.setUint32(40, abuffer.length * numOfChan * 2, true);
    for(i=0; i<abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));
    while(pos < abuffer.length) {
        for(i=0; i<numOfChan; i++) {
            sample = Math.max(-1, Math.min(1, channels[i][pos]));
            sample = (0.5+sample < 0 ? sample*32768 : sample*32767)|0;
            view.setInt16(44+offset, sample, true); offset+=2;
        } pos++;
    }
    return new Uint8Array(buffer);
}
function writeStr(v, o, s) { for(let i=0;i<s.length;i++) v.setUint8(o+i, s.charCodeAt(i)); }
function fmtTime(s) { return new Date(s*1000).toISOString().substr(14, 9); }
function showLoading(show, txt) { 
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; 
    if(txt) document.getElementById('loadingText').innerText = txt;
}
</script>

</body>
</html>
